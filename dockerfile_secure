# Use the latest Node.js LTS version with Debian Bookworm
FROM node:20-bookworm-slim

# Create app directory
WORKDIR /app

# Install system dependencies with security in mind
# Using --no-install-recommends to minimize attack surface
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        sqlite3 \
        ca-certificates \
        iputils-ping \
        dumb-init \
        curl \
        sudo \
        nscd \
        gnupg \
        && rm -rf /var/lib/apt/lists/* \
        && apt-get clean

# Create a non-root user for security
RUN groupadd -r nodejs && useradd -r -g nodejs nodejs

# Copy package files
COPY --chown=nodejs:nodejs package*.json ./

# Install dependencies as non-root user
USER nodejs
RUN npm ci --omit=dev --only=production

# Copy application code
COPY --chown=nodejs:nodejs . .

# Create data directory
RUN mkdir -p ./data

# Copy healthcheck utility
COPY --chown=nodejs:nodejs extra/healthcheck ./extra/healthcheck

# Set environment variables
ENV UPTIME_KUMA_IS_CONTAINER=1
ENV NODE_ENV=production

# Expose port
EXPOSE 3001

# Health check
HEALTHCHECK --interval=60s --timeout=30s --start-period=180s --retries=5 CMD ./extra/healthcheck

# Set up dumb-init to handle signals properly
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Start the application
CMD ["node", "server/server.js"]
